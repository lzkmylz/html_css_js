<!DOCTYPE html>

<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>打砖块游戏</title>
    <meta name="author" content="lzkmylz">
    <style media="screen">
      canvas {
        border: 1px black solid;
      }
    </style>
  </head>
  <body>
    <canvas id="canvas" width="600" height="400"></canvas>
    <script type="text/javascript">
      var imageFromPath = function(path) {
        var imageObj = new Image();
        imageObj.src = path;
        return imageObj
      }
      var Paddle = function() {
        var image = imageFromPath('./paddle.png');
        var o = {
          image: image,
          x: 175,
          y: 300,
          speed: 5,
          moveLeft: function(context, canvas) {
            context.clearRect(0, 0, canvas.width, canvas.height);
            if (this.x - this.speed > 0) {
              this.x -= this.speed;
            }
            context.drawImage(this.image, this.x, this.y);
          },
          moveRight: function(context, canvas) {
            context.clearRect(0, 0, canvas.width, canvas.height);
            if (this.x + this.speed + this.image.width < canvas.width) {
              this.x += this.speed;
            }
            context.drawImage(this.image, this.x, this.y);
          },
        }
        return o
      }
      var Game = function(paddle) {
        var g = {
          actions: {},
          keys: {},
          keydowns: {},
        }
        var canvas = document.getElementById('canvas');
        var context = canvas.getContext('2d');
        var o = {
          canvas: canvas,
          context: context,
          g: g,
        }
        paddle.image.onload = function() {
          o.context.drawImage(paddle.image, paddle.x, paddle.y);
        };
        //events
        window.addEventListener('keydown', (event) => {
          g.keydowns[event.key] = true
        })
        window.addEventListener('keyup', (event) => {
          g.keydowns[event.key] = false
        })
        g.registerAction = function(key, callback) {
          g.actions[key] = callback
          g.keydowns[key] = false
        }
        //timer
        setInterval(function() {
          var actions = Object.keys(g.actions)
          for (var i = 0; i < actions.length; i++) {
            var key = actions[i]
            if (g.keydowns[key]) {
              g.actions[key]()
            }
          }
        }, 1000/60)
        return o
      }
      var __main = function() {
        var paddle = Paddle();
        var game = Game(paddle);
        //左右移动
        game.g.registerAction('a', function() {
          paddle.moveLeft(game.context, game.canvas);
        })
        game.g.registerAction('d', function() {
          paddle.moveRight(game.context, game.canvas);
        })

      }
      __main();
    </script>
  </body>
</html>
